/**
 * Marco Polo v1.2.4
 *
 * A modern jQuery plugin for autocomplete functionality on a text input.
 *
 * https://github.com/jstayton/jquery-marcopolo
 *
 * Copyright 2011 by Justin Stayton
 * Released under the MIT License
 * http://en.wikipedia.org/wiki/MIT_License
 */
(function(b){var m={};var g={cache:true,compare:false,data:{},delay:250,formatData:null,formatError:function(D,I,E,F,H,G){return"<em>Your search could not be completed at this time.</em>"},formatItem:function(F,D,G,E){return F.title||F.name},formatMinChars:function(F,D,G,E){return"<em>Your search must be at least <strong>"+F+"</strong> characters.</em>"},formatNoResults:function(F,D,G,E){return"<em>No results for <strong>"+F+"</strong>.</em>"},hideOnSelect:true,label:null,minChars:1,onChange:null,onError:null,onFocus:null,onMinChars:null,onNoResults:null,onRequestBefore:null,onRequestAfter:null,onResults:null,onSelect:function(F,D,G,E){G.val(F.title||F.name)},param:"q",required:false,selectable:"*",selected:null,url:null};var l={DOWN:40,ENTER:13,ESC:27,UP:38};var x=function(D,E){if(D&&!E.val()){D.show();return true}else{return false}};var C=function(D,E){if(D&&(typeof E==="undefined"||E.val())){D.hide();return true}else{return false}};var o=function(D,E){if(D){if(E.val()){D.hide()}else{D.show()}return true}else{return false}};var t=function(D,E){if(!D.url){D.url=E.closest("form").attr("action")}if(D.label){D.label=b(D.label).addClass("mp_label");C(D.label,E)}return D};var A=function(D){return D.children("li.mp_selectable:visible:first")};var f=function(D){return D.children("li.mp_selectable:visible:last")};var d=function(D){return D.children("li.mp_highlighted")};var j=function(D){return D.removeClass("mp_highlighted")};var c=function(D,E){j(d(E));return D.addClass("mp_highlighted")};var u=function(D){return c(A(D),D)};var s=function(F){var D=d(F);var E=D.prevAll("li.mp_selectable:visible:first");if(!E.length){E=f(F)}return c(E,F)};var w=function(F){var D=d(F);var E=D.nextAll("li.mp_selectable:visible:first");if(!E.length){E=A(F)}return c(E,F)};var e=function(D){if(D.children().length){D.show()}return D};var r=function(D){return D.hide()};var k=function(I,E,F,G){var D=b('<li class="mp_no_results" />');var H=F.formatNoResults&&F.formatNoResults.call(I,G,D,I,E);if(H){D.html(H)}if(F.onNoResults){F.onNoResults.call(I,G,D,I,E)}I.trigger("marcopolonoresults",[G,D,I,E]);if(H){D.appendTo(E);e(E)}else{r(E)}};var q=function(O,L,G,D,J){var K=O.data("marcoPolo");var H=K.selected;var E=G.compare&&H;var R;var F;var M=false;for(var I=0;J[I];I++){var P=J[I];var Q=b('<li class="mp_item" />');var N=G.formatItem.call(O,P,Q,O,L);Q.data("marcoPolo",P);Q.html(N).appendTo(L);if(E){if(G.compare===true){R=P;F=H}else{R=P[G.compare];F=H[G.compare]}if(R===F){c(Q,L);E=false;M=true}}}L.children(G.selectable).addClass("mp_selectable");if(G.onResults){G.onResults.call(O,J,O,L)}O.trigger("marcopoloresults",[J,O,L]);e(L);if(!M){u(L)}};var n=function(H,D,E,G,F){D.empty();if(E.formatData){F=E.formatData.call(H,F,H,D)}if(b.isEmptyObject(F)){k(H,D,E,G)}else{q(H,D,E,G,F)}};var B=function(K,E,F,G,J,I){E.empty();var D=b('<li class="mp_error" />');var H=F.formatError&&F.formatError.call(K,D,K,E,G,J,I);if(H){D.html(H)}if(F.onError){F.onError.call(K,D,K,E,G,J,I)}K.trigger("marcopoloerror",[D,K,E,G,J,I]);if(H){D.appendTo(E);e(E)}else{r(E)}};var v=function(I,E,F,G){if(!G.length){r(E).empty();return}E.empty();var D=b('<li class="mp_min_chars" />');var H=F.formatMinChars&&F.formatMinChars.call(I,F.minChars,D,I,E);if(H){D.html(H)}if(F.onMinChars){F.onMinChars.call(I,F.minChars,D,I,E)}I.trigger("marcopolominchars",[F.minChars,D,I,E]);if(H){D.appendTo(E);e(E)}else{r(E)}};var i=function(E){var D=E.data("marcoPolo");if(D.ajax){D.ajaxAborted=true;D.ajax.abort()}else{D.ajaxAborted=false}clearTimeout(D.timer);return D.ajaxAborted};var h=function(G,H,D,E){var F=H.data("marcoPolo");F.selected=null;F.value=G;if(E.onChange){E.onChange.call(H,G,H,D)}H.trigger("marcopolochange",[G,H,D])};var a=function(F,H,D,E){var G=H.data("marcoPolo");i(H);if(F!==G.value){h(F,H,D,E)}G.timer=setTimeout(function(){if(F.length<E.minChars){v(H,D,E,F);return}var L={};L[E.param]=F;var K=b.extend({},E.data,L);var J=E.url+(E.url.indexOf("?")===-1?"?":"&")+b.param(K);if(E.cache&&m[J]){n(H,D,E,F,m[J])}else{if(E.onRequestBefore){E.onRequestBefore.call(H,H,D)}H.trigger("marcopolorequestbefore",[H,D]);var I=H.parent().addClass("mp_busy");G.ajax=b.ajax({url:E.url,dataType:"json",data:K,success:function(M){n(H,D,E,F,M);m[J]=M},error:function(M,O,N){if(!G.ajaxAborted){B(H,D,E,M,O,N)}},complete:function(M,N){G.ajax=null;G.ajaxAborted=false;I.removeClass("mp_busy");if(E.onRequestAfter){E.onRequestAfter.call(H,H,D,M,N)}H.trigger("marcopolorequestafter",[H,D,M,N])}})}},E.delay)};var p=function(G,D,I,E,F){var H=I.data("marcoPolo");if(F.hideOnSelect){r(E)}H.selected=G;if(F.onSelect){F.onSelect.call(I,G,D,I,E)}I.trigger("marcopoloselect",[G,D,I,E]);if(I.val()!==H.value){H.value=I.val();r(E).empty()}};var z=function(G,D,E){var F=G.data("marcoPolo");i(G);r(D).empty();if(E.required&&!F.selected){G.val("");h("",G,D,E)}x(E.label,G)};var y={init:function(D){return this.each(function(){var I=b(this);if(I.data("marcoPolo")){return}var G=I.attr("autocomplete");I.attr("autocomplete","off");var E=b('<ol class="mp_list" />').hide().insertAfter(I);var F=t(b.extend({},g,D),I);var H={ajax:null,ajaxAborted:false,autocomplete:G,documentMouseup:null,focusPseudo:false,focusReal:false,$list:E,mousedown:false,selected:null,selectedMouseup:false,settings:F,timer:null,value:I.val()};I.data("marcoPolo",H);I.bind("focus.marcoPolo",function(){H.focusPseudo=true;H.focusReal=true;C(F.label);if(H.selectedMouseup){H.selectedMouseup=false}else{if(F.onFocus){F.onFocus.call(I,I,E)}I.trigger("marcopolofocus",[I,E]);a(I.val(),I,E,F)}}).bind("keydown.marcoPolo",function(K){switch(K.which){case l.UP:K.preventDefault();e(E);s(E);break;case l.DOWN:K.preventDefault();e(E);w(E);break;case l.ENTER:K.preventDefault();if(!E.is(":visible")){return}var J=d(E);if(J.length){p(J.data("marcoPolo"),J,I,E,F)}break;case l.ESC:i(I);r(E);break}}).bind("keyup.marcoPolo",function(J){if(I.val()!==H.value){a(I.val(),I,E,F)}}).bind("blur.marcoPolo",function(){H.focusReal=false;setTimeout(function(){if(!H.mousedown){H.focusPseudo=false;z(I,E,F)}},1)});E.mousedown(function(){H.mousedown=true}).delegate("li.mp_selectable","mouseover",function(){c(b(this),E)}).delegate("li.mp_selectable","mouseout",function(){j(b(this))}).delegate("li.mp_selectable","mouseup",function(){var J=b(this);p(J.data("marcoPolo"),J,I,E,F);H.selectedMouseup=true;I.focus()});b(document).bind("mouseup.marcoPolo",H.documentMouseup=function(){H.mousedown=false;if(!H.focusReal&&E.is(":visible")){H.focusPseudo=false;z(I,E,F)}});if(F.selected){p(F.selected,null,I,E,F)}o(F.label,I)})},change:function(D){return this.each(function(){var H=b(this);var G=H.data("marcoPolo");var E=G.$list;var F=G.settings;if(!G){return}if(D!==G.value){H.val(D);h(D,H,E,F);if(G.focusPseudo){i(H);r(E).empty()}else{o(F.label,H)}}})},destroy:function(){return this.each(function(){var G=b(this);var F=G.data("marcoPolo");var D=F.$list;var E=F.settings;if(!F){return}D.remove();if(F.autocomplete!=="off"){G.removeAttr("autocomplete")}if(E.label){E.label.removeClass("mp_label")}b(document).unbind("mouseup.marcoPolo",F.documentMouseup);G.unbind(".marcoPolo").removeData("marcoPolo")})},option:function(H,F){var G,E,D;if(typeof H==="undefined"){G=b(this);E=G.data("marcoPolo");D=E.settings;if(!E){return}return D}else{if(typeof F==="undefined"){if(b.isPlainObject(H)){return this.each(function(){G=b(this);E=G.data("marcoPolo");D=E.settings;if(!E){return}D=b.extend(D,H);t(D,G)})}else{G=b(this);E=G.data("marcoPolo");D=E.settings;if(!E){return}return D[H]}}else{return this.each(function(){G=b(this);E=G.data("marcoPolo");D=E.settings;if(!E){return}D[H]=F;t(D,G)})}}},search:function(D){return this.each(function(){var F=b(this);var E=F.data("marcoPolo");if(!E){return}if(typeof D!=="undefined"){F.val(D)}F.focus()})}};b.fn.marcoPolo=function(D){if(y[D]){return y[D].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof D==="object"||!D){return y.init.apply(this,arguments)}else{b.error("Method "+D+" does not exist on jQuery.marcoPolo")}}}})(jQuery);